<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•ç‰ˆç¼–è¾‘æµ‹è¯•</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        canvas { 
            border: 2px solid #ddd; 
            display: block; 
            margin: 20px 0;
            border-radius: 4px;
        }
        .controls {
            margin: 20px 0;
        }
        .controls button {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            margin-right: 10px;
            cursor: pointer;
        }
        .controls button:hover {
            background: #005a9e;
        }
        .info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .highlight {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” è°ƒè¯•ç‰ˆç¼–è¾‘æµ‹è¯•</h1>
        
        <div class="highlight">
            <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong><br>
            1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—<br>
            2. åªæœ‰æœ€åä¸€è¡Œï¼ˆç¬¬2è¡Œï¼‰çš„å•å…ƒæ ¼å¯ä»¥ç¼–è¾‘<br>
            3. åŒå‡»ä»»æ„å•å…ƒæ ¼æŸ¥çœ‹ç¼–è¾‘é™åˆ¶æ£€æŸ¥è¿‡ç¨‹
        </div>
        
        <div class="controls">
            <button onclick="testEditLastRow()">âœï¸ æµ‹è¯•ç¼–è¾‘æœ€åä¸€è¡Œ</button>
            <button onclick="testEditFirstRow()">ğŸš« æµ‹è¯•ç¼–è¾‘ç¬¬ä¸€è¡Œï¼ˆåº”è¯¥å¤±è´¥ï¼‰</button>
            <button onclick="showDataInfo()">ğŸ“Š æ˜¾ç¤ºæ•°æ®ä¿¡æ¯</button>
            <button onclick="console.clear()">ğŸ§¹ æ¸…ç©ºæ§åˆ¶å°</button>
        </div>
        
        <canvas id="debugCanvas" width="500" height="200"></canvas>
        
        <div class="info">
            <h3>ğŸ“‹ æµ‹è¯•æ•°æ®</h3>
            <p>è¡¨æ ¼åŒ…å«3è¡Œ3åˆ—æ•°æ®ï¼š</p>
            <ul>
                <li>ç¬¬0è¡Œ: A1, B1, C1 ï¼ˆ<strong>ä¸å¯ç¼–è¾‘</strong>ï¼‰</li>
                <li>ç¬¬1è¡Œ: A2, B2, C2 ï¼ˆ<strong>ä¸å¯ç¼–è¾‘</strong>ï¼‰</li>
                <li>ç¬¬2è¡Œ: A3, B3, C3 ï¼ˆ<strong>âœ… å¯ç¼–è¾‘</strong>ï¼‰</li>
            </ul>
        </div>
        
        <div id="status" class="info">
            <strong>çŠ¶æ€ï¼š</strong> ç­‰å¾…æ“ä½œ...
        </div>
    </div>

    <!-- åŠ è½½è°ƒè¯•ç‰ˆçš„CellEditor -->
    <script src="debug-cellEditor.js"></script>
    
    <script>
        console.log('ğŸš€ Debug test starting...');
        
        // æç®€æ•°æ®ç»“æ„
        class TestData {
            constructor() {
                this.currentRowCount = 3;
                this.cols = 3;
                this.data = [
                    ['A1', 'B1', 'C1'],
                    ['A2', 'B2', 'C2'],
                    ['A3', 'B3', 'C3']
                ];
                console.log('ğŸ“¦ TestData created:', this);
            }
            
            getCellValue(row, col) {
                const value = this.data[row] && this.data[row][col] ? this.data[row][col] : '';
                console.log(`ğŸ“– getCellValue(${row}, ${col}) = "${value}"`);
                return value;
            }
            
            setCellValue(row, col, value) {
                console.log(`ğŸ’¾ setCellValue(${row}, ${col}, "${value}")`);
                // æ—¶é—´åºåˆ—é™åˆ¶ï¼šåªèƒ½ç¼–è¾‘æœ€åä¸€è¡Œ
                if (row !== this.currentRowCount - 1) {
                    const error = `Can only edit the last row (${this.currentRowCount - 1}), attempted to edit row ${row}`;
                    console.error('âŒ', error);
                    throw new Error(error);
                }
                if (!this.data[row]) this.data[row] = [];
                this.data[row][col] = value;
                console.log('âœ… Value saved successfully');
            }
        }
        
        // æç®€æ¸²æŸ“å™¨
        class TestRenderer {
            constructor(canvas, data) {
                console.log('ğŸ¨ TestRenderer creating...');
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.data = data;
                this.config = {
                    cellWidth: 80,
                    cellHeight: 30,
                    headerHeight: 35
                };
                this.scrollX = 0;
                this.scrollY = 0;
                this.render();
                console.log('âœ… TestRenderer created');
            }
            
            render() {
                console.log('ğŸ–¼ï¸ Rendering...');
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.font = '14px -apple-system, BlinkMacSystemFont, sans-serif';
                this.ctx.strokeStyle = '#ddd';
                this.ctx.fillStyle = '#333';
                
                // ç»˜åˆ¶è¡¨æ ¼
                for (let row = 0; row < this.data.currentRowCount; row++) {
                    for (let col = 0; col < this.data.cols; col++) {
                        const x = col * this.config.cellWidth;
                        const y = this.config.headerHeight + row * this.config.cellHeight;
                        
                        // ç»˜åˆ¶è¾¹æ¡†
                        this.ctx.strokeRect(x, y, this.config.cellWidth, this.config.cellHeight);
                        
                        // é«˜äº®æœ€åä¸€è¡Œï¼ˆå¯ç¼–è¾‘è¡Œï¼‰
                        if (row === this.data.currentRowCount - 1) {
                            this.ctx.fillStyle = '#e6f3ff';
                            this.ctx.fillRect(x + 1, y + 1, this.config.cellWidth - 2, this.config.cellHeight - 2);
                            this.ctx.fillStyle = '#333';
                        }
                        
                        // ç»˜åˆ¶æ–‡æœ¬
                        const value = this.data.getCellValue(row, col);
                        this.ctx.fillText(value, x + 8, y + 20);
                    }
                }
                
                // ç»˜åˆ¶æ ‡é¢˜
                this.ctx.fillStyle = '#666';
                this.ctx.fillText('åŒå‡»è“è‰²åŒºåŸŸçš„å•å…ƒæ ¼è¿›è¡Œç¼–è¾‘', 10, 20);
                this.ctx.fillStyle = '#333';
            }
            
            getCellFromPosition(x, y) {
                const row = Math.floor((y - this.config.headerHeight) / this.config.cellHeight);
                const col = Math.floor(x / this.config.cellWidth);
                
                console.log(`ğŸ¯ getCellFromPosition(${x.toFixed(1)}, ${y.toFixed(1)}) = (${row}, ${col})`);
                
                if (row >= 0 && row < this.data.currentRowCount && col >= 0 && col < this.data.cols) {
                    return { row, col };
                }
                return { row: -1, col: -1 };
            }
        }
        
        // åˆå§‹åŒ–
        const canvas = document.getElementById('debugCanvas');
        const data = new TestData();
        const renderer = new TestRenderer(canvas, data);
        
        console.log('ğŸ”§ Creating CellEditor...');
        const editor = new CellEditor(canvas.parentElement, renderer, data);
        
        // è®¾ç½®å›è°ƒ
        editor.onEditStart = (row, col, value) => {
            console.log(`ğŸ¯ Edit started: (${row}, ${col}) = "${value}"`);
            updateStatus(`âœï¸ å¼€å§‹ç¼–è¾‘å•å…ƒæ ¼ (${row}, ${col})ï¼Œå€¼: "${value}"`);
        };
        
        editor.onEditComplete = (row, col, newValue) => {
            console.log(`âœ… Edit completed: (${row}, ${col}) = "${newValue}"`);
            renderer.render();
            updateStatus(`âœ… ç¼–è¾‘å®Œæˆï¼å•å…ƒæ ¼ (${row}, ${col}) æ–°å€¼: "${newValue}"`);
        };
        
        editor.onEditCancel = (row, col) => {
            console.log(`âŒ Edit canceled: (${row}, ${col})`);
            updateStatus(`âŒ å–æ¶ˆç¼–è¾‘å•å…ƒæ ¼ (${row}, ${col})`);
        };
        
        // åŒå‡»äº‹ä»¶
        canvas.addEventListener('dblclick', (e) => {
            console.log('=== ğŸ–±ï¸ DOUBLE CLICK EVENT ===');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const cell = renderer.getCellFromPosition(x, y);
            
            if (cell.row >= 0 && cell.col >= 0) {
                console.log(`ğŸ¯ Attempting to edit cell (${cell.row}, ${cell.col})`);
                updateStatus(`ğŸ–±ï¸ åŒå‡»å•å…ƒæ ¼ (${cell.row}, ${cell.col})`);
                
                const success = editor.startEdit(cell.row, cell.col);
                console.log(`Edit start result: ${success}`);
            } else {
                console.log('âŒ Click outside valid cell area');
                updateStatus('âŒ ç‚¹å‡»ä½ç½®ä¸åœ¨æœ‰æ•ˆå•å…ƒæ ¼å†…');
            }
            console.log('=== END DOUBLE CLICK EVENT ===');
        });
        
        // æµ‹è¯•å‡½æ•°
        function testEditLastRow() {
            console.log('=== ğŸ§ª TEST EDIT LAST ROW ===');
            const lastRow = data.currentRowCount - 1;
            updateStatus(`ğŸ§ª æµ‹è¯•ç¼–è¾‘æœ€åä¸€è¡Œ (${lastRow}, 0)`);
            const success = editor.startEdit(lastRow, 0);
            console.log(`Test result: ${success}`);
        }
        
        function testEditFirstRow() {
            console.log('=== ğŸ§ª TEST EDIT FIRST ROW (SHOULD FAIL) ===');
            updateStatus('ğŸ§ª æµ‹è¯•ç¼–è¾‘ç¬¬ä¸€è¡Œï¼ˆåº”è¯¥å¤±è´¥ï¼‰');
            const success = editor.startEdit(0, 0);
            console.log(`Test result: ${success} (should be false)`);
        }
        
        function showDataInfo() {
            console.log('=== ğŸ“Š DATA INFO ===');
            console.log('Current row count:', data.currentRowCount);
            console.log('Last editable row:', data.currentRowCount - 1);
            console.log('Data:', data.data);
            console.log('Editor state:', {
                isEditing: editor.isEditing,
                editingCell: editor.editingCell
            });
            
            updateStatus(`ğŸ“Š æ•°æ®ä¿¡æ¯ï¼šæ€»è¡Œæ•° ${data.currentRowCount}ï¼Œå¯ç¼–è¾‘è¡Œ ${data.currentRowCount - 1}`);
        }
        
        function updateStatus(message) {
            document.getElementById('status').innerHTML = `<strong>çŠ¶æ€ï¼š</strong> ${message}`;
        }
        
        // å…¨å±€è°ƒè¯•å¯¹è±¡
        window.debugTest = {
            data, renderer, editor,
            testEditLastRow, testEditFirstRow, showDataInfo
        };
        
        console.log('âœ… Debug test initialization complete');
        console.log('ğŸ¯ Try double-clicking on the blue cells (last row) to test editing');
        updateStatus('âœ… åˆå§‹åŒ–å®Œæˆï¼Œè¯·åŒå‡»è“è‰²å•å…ƒæ ¼æµ‹è¯•ç¼–è¾‘åŠŸèƒ½');
    </script>
</body>
</html>