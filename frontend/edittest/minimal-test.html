<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€å°åŒ–ç¼–è¾‘æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        canvas { border: 1px solid #ccc; display: block; margin: 20px 0; }
        .info { background: #f0f0f0; padding: 10px; margin: 10px 0; }
        button { margin: 5px; padding: 5px 10px; }
    </style>
</head>
<body>
    <h1>æœ€å°åŒ–ç¼–è¾‘æµ‹è¯•</h1>
    <p>è¿™ä¸ªæµ‹è¯•ä¸“é—¨æ£€æŸ¥CellEditorçš„åŸºæœ¬åŠŸèƒ½</p>
    
    <div class="info">
        <strong>æµ‹è¯•æ­¥éª¤ï¼š</strong><br>
        1. åŒå‡»Canvasä¸Šçš„å•å…ƒæ ¼<br>
        2. æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º<br>
        3. æ£€æŸ¥æ˜¯å¦å‡ºç°è¾“å…¥æ¡†
    </div>
    
    <canvas id="canvas" width="400" height="300"></canvas>
    
    <div>
        <button onclick="testEdit()">æ‰‹åŠ¨æµ‹è¯•ç¼–è¾‘</button>
        <button onclick="showStatus()">æ˜¾ç¤ºçŠ¶æ€</button>
        <button onclick="console.clear()">æ¸…ç©ºæ§åˆ¶å°</button>
    </div>
    
    <div id="status" class="info"></div>

    <script>
        // åˆ›å»ºä¸€ä¸ªæç®€çš„æ•°æ®ç»“æ„æ¨¡æ‹Ÿ
        class SimpleData {
            constructor() {
                this.currentRowCount = 3;
                this.cols = 3;
                this.data = [
                    ['A1', 'B1', 'C1'],
                    ['A2', 'B2', 'C2'],
                    ['A3', 'B3', 'C3']
                ];
            }
            
            getCellValue(row, col) {
                return this.data[row] && this.data[row][col] ? this.data[row][col] : '';
            }
            
            setCellValue(row, col, value) {
                console.log(`setCellValue called: (${row}, ${col}) = "${value}"`);
                // æ—¶é—´åºåˆ—é™åˆ¶ï¼šåªèƒ½ç¼–è¾‘æœ€åä¸€è¡Œ
                if (row !== this.currentRowCount - 1) {
                    throw new Error(`Can only edit the last row (${this.currentRowCount - 1}), attempted to edit row ${row}`);
                }
                if (!this.data[row]) this.data[row] = [];
                this.data[row][col] = value;
            }
        }
        
        // åˆ›å»ºä¸€ä¸ªæç®€çš„æ¸²æŸ“å™¨æ¨¡æ‹Ÿ
        class SimpleRenderer {
            constructor(canvas, data) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.data = data;
                this.config = {
                    cellWidth: 80,
                    cellHeight: 30,
                    headerHeight: 35
                };
                this.scrollX = 0;
                this.scrollY = 0;
                this.render();
            }
            
            render() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.font = '14px Arial';
                this.ctx.strokeStyle = '#ccc';
                
                // ç»˜åˆ¶ç½‘æ ¼å’Œæ•°æ®
                for (let row = 0; row < this.data.currentRowCount; row++) {
                    for (let col = 0; col < this.data.cols; col++) {
                        const x = col * this.config.cellWidth;
                        const y = this.config.headerHeight + row * this.config.cellHeight;
                        
                        // ç»˜åˆ¶è¾¹æ¡†
                        this.ctx.strokeRect(x, y, this.config.cellWidth, this.config.cellHeight);
                        
                        // ç»˜åˆ¶æ–‡æœ¬
                        const value = this.data.getCellValue(row, col);
                        this.ctx.fillText(value, x + 5, y + 20);
                    }
                }
            }
            
            getCellFromPosition(x, y) {
                const row = Math.floor((y - this.config.headerHeight) / this.config.cellHeight);
                const col = Math.floor(x / this.config.cellWidth);
                
                if (row >= 0 && row < this.data.currentRowCount && col >= 0 && col < this.data.cols) {
                    return { row, col };
                }
                return { row: -1, col: -1 };
            }
        }
        
        // åˆå§‹åŒ–
        const canvas = document.getElementById('canvas');
        const data = new SimpleData();
        const renderer = new SimpleRenderer(canvas, data);
        
        console.log('=== åˆå§‹åŒ–å®Œæˆ ===');
        console.log('æ•°æ®ç»“æ„:', data);
        console.log('æ¸²æŸ“å™¨:', renderer);
        
        // æ£€æŸ¥CellEditoræ˜¯å¦å­˜åœ¨
        if (typeof CellEditor === 'undefined') {
            console.error('CellEditor ç±»æœªå®šä¹‰ï¼');
            document.getElementById('status').innerHTML = '<strong style="color: red;">é”™è¯¯ï¼šCellEditor ç±»æœªå®šä¹‰ï¼è¯·æ£€æŸ¥cellEditor.jsæ˜¯å¦æ­£ç¡®åŠ è½½ã€‚</strong>';
        } else {
            console.log('CellEditor ç±»å·²åŠ è½½');
            
            // åˆ›å»ºç¼–è¾‘å™¨
            const editor = new CellEditor(canvas.parentElement, renderer, data);
            
            // è®¾ç½®å›è°ƒ
            editor.onEditStart = (row, col, value) => {
                console.log(`ğŸ¯ ç¼–è¾‘å¼€å§‹: (${row}, ${col}) = "${value}"`);
                document.getElementById('status').innerHTML = `<strong>ç¼–è¾‘å¼€å§‹:</strong> å•å…ƒæ ¼ (${row}, ${col})ï¼Œå€¼: "${value}"`;
            };
            
            editor.onEditComplete = (row, col, newValue) => {
                console.log(`âœ… ç¼–è¾‘å®Œæˆ: (${row}, ${col}) = "${newValue}"`);
                renderer.render();
                document.getElementById('status').innerHTML = `<strong>ç¼–è¾‘å®Œæˆ:</strong> å•å…ƒæ ¼ (${row}, ${col})ï¼Œæ–°å€¼: "${newValue}"`;
            };
            
            editor.onEditCancel = (row, col) => {
                console.log(`âŒ ç¼–è¾‘å–æ¶ˆ: (${row}, ${col})`);
                document.getElementById('status').innerHTML = `<strong>ç¼–è¾‘å–æ¶ˆ:</strong> å•å…ƒæ ¼ (${row}, ${col})`;
            };
            
            // åŒå‡»äº‹ä»¶
            canvas.addEventListener('dblclick', (e) => {
                console.log('=== åŒå‡»äº‹ä»¶ ===');
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                console.log(`åŒå‡»ä½ç½®: (${x.toFixed(1)}, ${y.toFixed(1)})`);
                
                const cell = renderer.getCellFromPosition(x, y);
                console.log(`è®¡ç®—å•å…ƒæ ¼: (${cell.row}, ${cell.col})`);
                
                if (cell.row >= 0 && cell.col >= 0) {
                    console.log(`å°è¯•ç¼–è¾‘å•å…ƒæ ¼ (${cell.row}, ${cell.col})`);
                    const canEdit = editor.canEditCell(cell.row, cell.col);
                    console.log(`æ˜¯å¦å¯ç¼–è¾‘: ${canEdit}`);
                    
                    if (canEdit) {
                        const success = editor.startEdit(cell.row, cell.col);
                        console.log(`ç¼–è¾‘å¯åŠ¨: ${success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
                    } else {
                        console.log('âŒ å•å…ƒæ ¼ä¸å¯ç¼–è¾‘ï¼ˆæ—¶é—´åºåˆ—é™åˆ¶ï¼‰');
                        document.getElementById('status').innerHTML = `<strong style="color: orange;">å•å…ƒæ ¼ (${cell.row}, ${cell.col}) ä¸å¯ç¼–è¾‘</strong><br>åªèƒ½ç¼–è¾‘æœ€åä¸€è¡Œ (${data.currentRowCount - 1})`;
                    }
                } else {
                    console.log('âŒ åŒå‡»ä½ç½®ä¸åœ¨æœ‰æ•ˆå•å…ƒæ ¼å†…');
                }
            });
            
            // æµ‹è¯•å‡½æ•°
            window.testEdit = function() {
                console.log('=== æ‰‹åŠ¨æµ‹è¯•ç¼–è¾‘ ===');
                const lastRow = data.currentRowCount - 1;
                console.log(`æµ‹è¯•ç¼–è¾‘æœ€åä¸€è¡Œ: (${lastRow}, 0)`);
                const success = editor.startEdit(lastRow, 0);
                console.log(`ç¼–è¾‘å¯åŠ¨: ${success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
            };
            
            window.showStatus = function() {
                console.log('=== å½“å‰çŠ¶æ€ ===');
                console.log(`æ•°æ®è¡Œæ•°: ${data.currentRowCount}`);
                console.log(`å¯ç¼–è¾‘è¡Œ: ${data.currentRowCount - 1}`);
                console.log(`ç¼–è¾‘å™¨çŠ¶æ€: ${editor.isEditing ? 'æ­£åœ¨ç¼–è¾‘' : 'æœªç¼–è¾‘'}`);
                console.log('æ•°æ®å†…å®¹:', data.data);
                
                document.getElementById('status').innerHTML = `
                    <strong>å½“å‰çŠ¶æ€:</strong><br>
                    æ•°æ®è¡Œæ•°: ${data.currentRowCount}<br>
                    å¯ç¼–è¾‘è¡Œ: ${data.currentRowCount - 1}<br>
                    ç¼–è¾‘å™¨çŠ¶æ€: ${editor.isEditing ? 'æ­£åœ¨ç¼–è¾‘' : 'æœªç¼–è¾‘'}
                `;
            };
            
            // ä¿å­˜åˆ°å…¨å±€å˜é‡ç”¨äºè°ƒè¯•
            window.debugEditor = {
                data: data,
                renderer: renderer,
                editor: editor
            };
            
            console.log('=== è®¾ç½®å®Œæˆ ===');
            console.log('è¯·åŒå‡»Canvasä¸Šçš„å•å…ƒæ ¼è¿›è¡Œæµ‹è¯•');
            console.log('æˆ–ç‚¹å‡»"æ‰‹åŠ¨æµ‹è¯•ç¼–è¾‘"æŒ‰é’®');
        }
    </script>
    
    <!-- å°è¯•åŠ è½½CellEditor -->
    <script src="../cellEditor.js"></script>
</body>
</html>