<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最小化编辑测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        canvas { border: 1px solid #ccc; display: block; margin: 20px 0; }
        .info { background: #f0f0f0; padding: 10px; margin: 10px 0; }
        button { margin: 5px; padding: 5px 10px; }
    </style>
</head>
<body>
    <h1>最小化编辑测试</h1>
    <p>这个测试专门检查CellEditor的基本功能</p>
    
    <div class="info">
        <strong>测试步骤：</strong><br>
        1. 双击Canvas上的单元格<br>
        2. 查看控制台输出<br>
        3. 检查是否出现输入框
    </div>
    
    <canvas id="canvas" width="400" height="300"></canvas>
    
    <div>
        <button onclick="testEdit()">手动测试编辑</button>
        <button onclick="showStatus()">显示状态</button>
        <button onclick="console.clear()">清空控制台</button>
    </div>
    
    <div id="status" class="info"></div>

    <script>
        // 创建一个极简的数据结构模拟
        class SimpleData {
            constructor() {
                this.currentRowCount = 3;
                this.cols = 3;
                this.data = [
                    ['A1', 'B1', 'C1'],
                    ['A2', 'B2', 'C2'],
                    ['A3', 'B3', 'C3']
                ];
            }
            
            getCellValue(row, col) {
                return this.data[row] && this.data[row][col] ? this.data[row][col] : '';
            }
            
            setCellValue(row, col, value) {
                console.log(`setCellValue called: (${row}, ${col}) = "${value}"`);
                // 时间序列限制：只能编辑最后一行
                if (row !== this.currentRowCount - 1) {
                    throw new Error(`Can only edit the last row (${this.currentRowCount - 1}), attempted to edit row ${row}`);
                }
                if (!this.data[row]) this.data[row] = [];
                this.data[row][col] = value;
            }
        }
        
        // 创建一个极简的渲染器模拟
        class SimpleRenderer {
            constructor(canvas, data) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.data = data;
                this.config = {
                    cellWidth: 80,
                    cellHeight: 30,
                    headerHeight: 35
                };
                this.scrollX = 0;
                this.scrollY = 0;
                this.render();
            }
            
            render() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.font = '14px Arial';
                this.ctx.strokeStyle = '#ccc';
                
                // 绘制网格和数据
                for (let row = 0; row < this.data.currentRowCount; row++) {
                    for (let col = 0; col < this.data.cols; col++) {
                        const x = col * this.config.cellWidth;
                        const y = this.config.headerHeight + row * this.config.cellHeight;
                        
                        // 绘制边框
                        this.ctx.strokeRect(x, y, this.config.cellWidth, this.config.cellHeight);
                        
                        // 绘制文本
                        const value = this.data.getCellValue(row, col);
                        this.ctx.fillText(value, x + 5, y + 20);
                    }
                }
            }
            
            getCellFromPosition(x, y) {
                const row = Math.floor((y - this.config.headerHeight) / this.config.cellHeight);
                const col = Math.floor(x / this.config.cellWidth);
                
                if (row >= 0 && row < this.data.currentRowCount && col >= 0 && col < this.data.cols) {
                    return { row, col };
                }
                return { row: -1, col: -1 };
            }
        }
        
        // 初始化
        const canvas = document.getElementById('canvas');
        const data = new SimpleData();
        const renderer = new SimpleRenderer(canvas, data);
        
        console.log('=== 初始化完成 ===');
        console.log('数据结构:', data);
        console.log('渲染器:', renderer);
        
        // 检查CellEditor是否存在
        if (typeof CellEditor === 'undefined') {
            console.error('CellEditor 类未定义！');
            document.getElementById('status').innerHTML = '<strong style="color: red;">错误：CellEditor 类未定义！请检查cellEditor.js是否正确加载。</strong>';
        } else {
            console.log('CellEditor 类已加载');
            
            // 创建编辑器
            const editor = new CellEditor(canvas.parentElement, renderer, data);
            
            // 设置回调
            editor.onEditStart = (row, col, value) => {
                console.log(`🎯 编辑开始: (${row}, ${col}) = "${value}"`);
                document.getElementById('status').innerHTML = `<strong>编辑开始:</strong> 单元格 (${row}, ${col})，值: "${value}"`;
            };
            
            editor.onEditComplete = (row, col, newValue) => {
                console.log(`✅ 编辑完成: (${row}, ${col}) = "${newValue}"`);
                renderer.render();
                document.getElementById('status').innerHTML = `<strong>编辑完成:</strong> 单元格 (${row}, ${col})，新值: "${newValue}"`;
            };
            
            editor.onEditCancel = (row, col) => {
                console.log(`❌ 编辑取消: (${row}, ${col})`);
                document.getElementById('status').innerHTML = `<strong>编辑取消:</strong> 单元格 (${row}, ${col})`;
            };
            
            // 双击事件
            canvas.addEventListener('dblclick', (e) => {
                console.log('=== 双击事件 ===');
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                console.log(`双击位置: (${x.toFixed(1)}, ${y.toFixed(1)})`);
                
                const cell = renderer.getCellFromPosition(x, y);
                console.log(`计算单元格: (${cell.row}, ${cell.col})`);
                
                if (cell.row >= 0 && cell.col >= 0) {
                    console.log(`尝试编辑单元格 (${cell.row}, ${cell.col})`);
                    const canEdit = editor.canEditCell(cell.row, cell.col);
                    console.log(`是否可编辑: ${canEdit}`);
                    
                    if (canEdit) {
                        const success = editor.startEdit(cell.row, cell.col);
                        console.log(`编辑启动: ${success ? '成功' : '失败'}`);
                    } else {
                        console.log('❌ 单元格不可编辑（时间序列限制）');
                        document.getElementById('status').innerHTML = `<strong style="color: orange;">单元格 (${cell.row}, ${cell.col}) 不可编辑</strong><br>只能编辑最后一行 (${data.currentRowCount - 1})`;
                    }
                } else {
                    console.log('❌ 双击位置不在有效单元格内');
                }
            });
            
            // 测试函数
            window.testEdit = function() {
                console.log('=== 手动测试编辑 ===');
                const lastRow = data.currentRowCount - 1;
                console.log(`测试编辑最后一行: (${lastRow}, 0)`);
                const success = editor.startEdit(lastRow, 0);
                console.log(`编辑启动: ${success ? '成功' : '失败'}`);
            };
            
            window.showStatus = function() {
                console.log('=== 当前状态 ===');
                console.log(`数据行数: ${data.currentRowCount}`);
                console.log(`可编辑行: ${data.currentRowCount - 1}`);
                console.log(`编辑器状态: ${editor.isEditing ? '正在编辑' : '未编辑'}`);
                console.log('数据内容:', data.data);
                
                document.getElementById('status').innerHTML = `
                    <strong>当前状态:</strong><br>
                    数据行数: ${data.currentRowCount}<br>
                    可编辑行: ${data.currentRowCount - 1}<br>
                    编辑器状态: ${editor.isEditing ? '正在编辑' : '未编辑'}
                `;
            };
            
            // 保存到全局变量用于调试
            window.debugEditor = {
                data: data,
                renderer: renderer,
                editor: editor
            };
            
            console.log('=== 设置完成 ===');
            console.log('请双击Canvas上的单元格进行测试');
            console.log('或点击"手动测试编辑"按钮');
        }
    </script>
    
    <!-- 尝试加载CellEditor -->
    <script src="../cellEditor.js"></script>
</body>
</html>