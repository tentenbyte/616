<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>编辑测试 - 一个文件解决问题</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        canvas { border: 1px solid #ccc; display: block; margin: 20px 0; }
        button { margin: 5px; padding: 8px 16px; }
        .log { background: #f0f0f0; padding: 10px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>编辑测试</h1>
    <p>目标：找出为什么双击无法编辑</p>
    
    <button onclick="testEdit()">手动测试编辑最后一行</button>
    <button onclick="console.clear()">清空日志</button>
    
    <canvas id="canvas" width="400" height="200"></canvas>
    
    <div id="log" class="log">等待测试...\n</div>

    <!-- 加载原始模块 -->
    <script src="../dataStructures.js"></script>
    <script src="../canvasRenderer.js"></script>
    <script src="../cellEditor.js"></script>
    
    <script>
        function log(msg) {
            console.log(msg);
            document.getElementById('log').textContent += msg + '\n';
        }
        
        // 使用原始模块创建简单测试
        log('创建数据结构...');
        const data = new TableDataStructures(5, 3);
        
        // 加载一些测试数据
        const testData = [
            ['A', 'B', 'C'],
            ['1', '2', '3'],
            ['X', 'Y', 'Z']
        ];
        
        // 临时移除编辑限制来加载数据
        const origSetCell = data.setCellValue;
        data.setCellValue = function(row, col, value) {
            const stringIndex = this.addString(value);
            const cellIndex = col * this.rows + row;
            this.cellDataView[cellIndex] = stringIndex;
        };
        
        for (let row = 0; row < testData.length; row++) {
            for (let col = 0; col < testData[row].length; col++) {
                data.setCellValue(row, col, testData[row][col]);
            }
        }
        
        data.currentRowCount = testData.length;
        data.setCellValue = origSetCell; // 恢复限制
        
        log('创建渲染器...');
        const canvas = document.getElementById('canvas');
        const renderer = new CanvasTableRenderer(canvas, data);
        
        log('创建编辑器...');
        const editor = new CellEditor(canvas.parentElement, renderer, data);
        
        // 设置回调
        editor.onEditStart = (row, col, value) => {
            log(`✅ 编辑开始: (${row}, ${col}) = "${value}"`);
        };
        
        editor.onEditComplete = (row, col, newValue) => {
            log(`✅ 编辑完成: (${row}, ${col}) = "${newValue}"`);
            renderer.render();
        };
        
        // 双击事件 - 这是关键！
        canvas.addEventListener('dblclick', (e) => {
            log('--- 双击事件开始 ---');
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            log(`鼠标位置: (${x.toFixed(1)}, ${y.toFixed(1)})`);
            
            const cell = renderer.getCellFromPosition(x, y);
            log(`计算单元格: (${cell.row}, ${cell.col})`);
            
            if (cell.row >= 0 && cell.col >= 0) {
                log(`尝试编辑单元格 (${cell.row}, ${cell.col})`);
                log(`当前行数: ${data.currentRowCount}, 最后一行: ${data.currentRowCount - 1}`);
                
                const canEdit = editor.canEditCell(cell.row, cell.col);
                log(`是否可编辑: ${canEdit}`);
                
                if (canEdit) {
                    const success = editor.startEdit(cell.row, cell.col);
                    log(`编辑启动结果: ${success}`);
                    if (!success) {
                        log('❌ 编辑启动失败！');
                    }
                } else {
                    log(`❌ 不能编辑: 只能编辑第${data.currentRowCount - 1}行，你点击的是第${cell.row}行`);
                }
            } else {
                log('❌ 点击位置不在有效单元格内');
            }
            
            log('--- 双击事件结束 ---');
        });
        
        // 手动测试函数
        function testEdit() {
            log('=== 手动测试开始 ===');
            const lastRow = data.currentRowCount - 1;
            log(`测试编辑最后一行: (${lastRow}, 0)`);
            
            const success = editor.startEdit(lastRow, 0);
            log(`手动编辑结果: ${success}`);
            
            if (!success) {
                log('❌ 手动编辑也失败了！问题可能在CellEditor内部');
            }
        }
        
        renderer.render();
        log('初始化完成！现在双击最后一行的单元格试试');
        log(`可编辑的行是第${data.currentRowCount - 1}行（最后一行）`);
        
        // 调试对象
        window.debug = { data, renderer, editor };
    </script>
</body>
</html>