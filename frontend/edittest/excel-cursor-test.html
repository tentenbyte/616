<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Excel光标测试</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 900px;
            margin: 0 auto;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .section {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        canvas { 
            border: 2px solid #ddd; 
            display: block; 
            margin: 10px 0;
            border-radius: 4px;
        }
        .instructions {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .instructions h3 {
            margin-top: 0;
            color: #1976d2;
        }
        .test-list li {
            margin-bottom: 8px;
        }
        .correct { color: #4caf50; font-weight: bold; }
        .incorrect { color: #f44336; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Excel光标行为测试</h1>
        
        <div class="instructions">
            <h3>🎯 Excel的正确光标行为</h3>
            <ul class="test-list">
                <li><span class="correct">双击</span> → 光标在点击位置，<strong>不全选</strong></li>
                <li><span class="correct">F2</span> → 光标在文本末尾，不全选</li>
                <li><span class="correct">Enter</span> → 光标在文本末尾，不全选</li>
                <li><span class="correct">直接输入</span> → 全选替换原文本</li>
                <li><span class="correct">Backspace</span> → 清空后光标在开头</li>
            </ul>
        </div>
        
        <div class="comparison">
            <div class="section">
                <h3>❌ 之前的错误行为</h3>
                <p>双击 → 全选文本（错误）</p>
                <canvas id="oldCanvas" width="300" height="150"></canvas>
                <p><small>模拟：双击后文本被全选</small></p>
            </div>
            
            <div class="section">
                <h3>✅ 修正后的Excel风格</h3>
                <p>双击 → 光标在末尾（正确）</p>
                <canvas id="newCanvas" width="300" height="150"></canvas>
                <p><small>实际测试：双击后光标在文本末尾</small></p>
            </div>
        </div>
        
        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 15px;">
            <h3>🧪 测试步骤</h3>
            <ol>
                <li>在右侧表格中选择一个有文本的单元格</li>
                <li>双击该单元格</li>
                <li>观察：文本是否被全选？</li>
                <li>如果只有光标闪烁（不全选），则行为正确</li>
                <li>尝试F2键，应该在文本末尾插入光标</li>
                <li>尝试直接输入字母，应该替换全部文本</li>
            </ol>
        </div>
    </div>

    <!-- 加载原始模块 -->
    <script src="../dataStructures.js"></script>
    <script src="../canvasRenderer.js"></script>
    <script src="../cellEditor.js"></script>
    
    <script>
        // 创建左侧演示（旧行为）
        function createOldBehaviorDemo() {
            const canvas = document.getElementById('oldCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '14px Arial';
            ctx.strokeStyle = '#ddd';
            ctx.fillStyle = '#333';
            
            // 绘制单元格
            ctx.strokeRect(50, 50, 200, 30);
            ctx.fillText('双击我试试', 60, 70);
            
            // 添加说明
            ctx.fillStyle = '#f44336';
            ctx.font = '12px Arial';
            ctx.fillText('旧版本：双击后全选（错误）', 50, 100);
            
            // 模拟全选效果
            canvas.addEventListener('dblclick', () => {
                ctx.clearRect(50, 50, 200, 30);
                ctx.fillStyle = '#2196f3';
                ctx.fillRect(51, 51, 198, 28);
                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.fillText('双击我试试', 60, 70);
                
                setTimeout(() => {
                    ctx.clearRect(50, 50, 200, 30);
                    ctx.strokeStyle = '#ddd';
                    ctx.strokeRect(50, 50, 200, 30);
                    ctx.fillStyle = '#333';
                    ctx.fillText('双击我试试', 60, 70);
                }, 1000);
            });
        }
        
        // 创建右侧测试（新行为）
        function createNewBehaviorTest() {
            const data = new TableDataStructures(4, 3);
            
            const testData = [
                ['产品', '价格', '库存'],
                ['iPhone', '6999', '50'],
                ['MacBook', '12999', '20']
            ];
            
            // 临时移除限制加载数据
            const originalSetCell = data.setCellValue;
            data.setCellValue = function(row, col, value) {
                const stringIndex = this.addString(value);
                const cellIndex = col * this.rows + row;
                this.cellDataView[cellIndex] = stringIndex;
            };
            
            for (let row = 0; row < testData.length; row++) {
                for (let col = 0; col < testData[row].length; col++) {
                    data.setCellValue(row, col, testData[row][col]);
                }
            }
            
            data.currentRowCount = testData.length;
            data.setCellValue = originalSetCell;
            
            const canvas = document.getElementById('newCanvas');
            const renderer = new CanvasTableRenderer(canvas, data);
            const editor = new CellEditor(canvas.parentElement, renderer, data);
            
            // 设置回调来显示行为
            editor.onEditStart = (row, col, value) => {
                console.log(`编辑开始: (${row}, ${col}) = "${value}"`);
                
                // 检查输入框的选择状态
                setTimeout(() => {
                    const input = document.querySelector('.cell-editor-input');
                    if (input) {
                        const selectionStart = input.selectionStart;
                        const selectionEnd = input.selectionEnd;
                        const isSelected = selectionStart !== selectionEnd;
                        
                        console.log(`光标位置: ${selectionStart}-${selectionEnd}, 是否全选: ${isSelected}`);
                        
                        if (isSelected) {
                            console.log('❌ 文本被全选了（不符合Excel行为）');
                        } else {
                            console.log('✅ 光标插入，没有全选（符合Excel行为）');
                        }
                    }
                }, 100);
            };
            
            // 双击事件
            canvas.addEventListener('dblclick', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const cell = renderer.getCellFromPosition(x, y);
                
                if (cell.row >= 0 && cell.col >= 0) {
                    console.log('双击检测，启动Excel风格编辑...');
                    editor.startEdit(cell.row, cell.col, '', 'normal');
                }
            });
            
            // 键盘事件
            document.addEventListener('keydown', (e) => {
                if (editor.isEditing) return;
                
                const selected = renderer.getSelectedCell();
                if (selected.row < 0 || selected.col < 0) return;
                
                switch (e.key) {
                    case 'F2':
                        console.log('F2键检测，光标应该在末尾...');
                        editor.startEdit(selected.row, selected.col, '', 'append');
                        e.preventDefault();
                        break;
                    default:
                        if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
                            console.log('直接输入检测，应该全选替换...');
                            editor.startEdit(selected.row, selected.col, e.key, 'replace');
                            e.preventDefault();
                        }
                        break;
                }
            });
            
            // 单击选择
            renderer.onCellSelected = (row, col) => {
                console.log(`选中单元格 (${row}, ${col})`);
            };
            
            renderer.render();
        }
        
        // 初始化
        createOldBehaviorDemo();
        createNewBehaviorTest();
        
        console.log('🧪 Excel光标行为测试已准备就绪');
        console.log('双击右侧表格中的单元格，查看控制台输出');
    </script>
</body>
</html>