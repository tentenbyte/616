<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Excel风格编辑测试</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .instructions {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .instructions h3 {
            margin-top: 0;
            color: #1976d2;
        }
        .instructions ul {
            margin-bottom: 0;
        }
        .instructions li {
            margin-bottom: 5px;
        }
        canvas { 
            border: 2px solid #ddd; 
            display: block; 
            margin: 20px 0;
            border-radius: 4px;
        }
        .status {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 Excel风格编辑测试</h1>
        
        <div class="instructions">
            <h3>🎯 Excel风格操作说明</h3>
            <ul>
                <li><strong>单击</strong> - 选中单元格（显示蓝色边框）</li>
                <li><strong>双击</strong> - 进入编辑模式</li>
                <li><strong>F2</strong> - 进入编辑模式</li>
                <li><strong>直接输入字母/数字</strong> - 替换单元格内容并进入编辑模式</li>
                <li><strong>Enter</strong> - 保存编辑并移动到下一行</li>
                <li><strong>Tab</strong> - 保存编辑并移动到右侧单元格</li>
                <li><strong>Shift+Tab</strong> - 保存编辑并移动到左侧单元格</li>
                <li><strong>Escape</strong> - 取消编辑</li>
                <li><strong>Delete</strong> - 清空单元格内容</li>
                <li><strong>Backspace</strong> - 清空单元格并进入编辑模式</li>
                <li><strong>方向键</strong> - 移动选择</li>
            </ul>
        </div>
        
        <canvas id="excelCanvas" width="600" height="300"></canvas>
        
        <div id="status" class="status">
            等待操作...
        </div>
    </div>

    <!-- 加载所有模块 -->
    <script src="../dataStructures.js"></script>
    <script src="../canvasRenderer.js"></script>
    <script src="../cellEditor.js"></script>
    
    <script>
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // 创建测试数据
        const data = new TableDataStructures(6, 4);
        
        // 加载示例数据
        const testData = [
            ['姓名', '年龄', '城市', '职业'],
            ['张三', '25', '北京', '工程师'],
            ['李四', '30', '上海', '设计师'],
            ['王五', '28', '广州', '产品经理'],
            ['赵六', '35', '深圳', '架构师']
        ];
        
        // 临时移除编辑限制
        const originalSetCell = data.setCellValue;
        data.setCellValue = function(row, col, value) {
            const stringIndex = this.addString(value);
            const cellIndex = col * this.rows + row;
            this.cellDataView[cellIndex] = stringIndex;
        };
        
        // 加载数据
        for (let row = 0; row < testData.length; row++) {
            for (let col = 0; col < testData[row].length; col++) {
                data.setCellValue(row, col, testData[row][col]);
            }
        }
        
        data.currentRowCount = testData.length;
        data.setCellValue = originalSetCell; // 恢复（但仍然是注释状态）
        
        // 创建渲染器和编辑器
        const canvas = document.getElementById('excelCanvas');
        const renderer = new CanvasTableRenderer(canvas, data);
        const editor = new CellEditor(canvas.parentElement, renderer, data);
        
        // 设置回调
        editor.onEditStart = (row, col, value) => {
            updateStatus(`✏️ 开始编辑单元格 (${row + 1}, ${getColumnName(col)}): "${value}"`);
        };
        
        editor.onEditComplete = (row, col, newValue) => {
            updateStatus(`✅ 编辑完成 (${row + 1}, ${getColumnName(col)}): "${newValue}"`);
            renderer.render();
        };
        
        editor.onEditCancel = (row, col) => {
            updateStatus(`❌ 取消编辑 (${row + 1}, ${getColumnName(col)})`);
        };
        
        editor.onCellMove = (row, col) => {
            const cellValue = data.getCellValue(row, col);
            updateStatus(`📍 移动到单元格 (${row + 1}, ${getColumnName(col)}): "${cellValue}"`);
        };
        
        // 单击选择
        renderer.onCellSelected = (row, col) => {
            const cellValue = data.getCellValue(row, col);
            updateStatus(`🎯 选中单元格 (${row + 1}, ${getColumnName(col)}): "${cellValue}"`);
        };
        
        // 双击编辑
        canvas.addEventListener('dblclick', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const cell = renderer.getCellFromPosition(x, y);
            
            if (cell.row >= 0 && cell.col >= 0) {
                editor.startEdit(cell.row, cell.col);
            }
        });
        
        // 键盘事件处理（简化版）
        document.addEventListener('keydown', (e) => {
            if (editor.isEditing) return;
            
            const selected = renderer.getSelectedCell();
            if (selected.row < 0 || selected.col < 0) return;
            
            let newRow = selected.row;
            let newCol = selected.col;
            
            switch (e.key) {
                case 'ArrowUp':
                    newRow = Math.max(0, selected.row - 1);
                    e.preventDefault();
                    break;
                case 'ArrowDown':
                    newRow = Math.min(data.currentRowCount - 1, selected.row + 1);
                    e.preventDefault();
                    break;
                case 'ArrowLeft':
                    newCol = Math.max(0, selected.col - 1);
                    e.preventDefault();
                    break;
                case 'ArrowRight':
                    newCol = Math.min(data.cols - 1, selected.col + 1);
                    e.preventDefault();
                    break;
                case 'Enter':
                case 'F2':
                    editor.startEdit(selected.row, selected.col);
                    e.preventDefault();
                    break;
                case 'Tab':
                    e.preventDefault();
                    if (e.shiftKey) {
                        newCol = Math.max(0, selected.col - 1);
                    } else {
                        newCol = Math.min(data.cols - 1, selected.col + 1);
                    }
                    break;
                case 'Delete':
                    data.setCellValue(selected.row, selected.col, '');
                    renderer.render();
                    updateStatus(`🗑️ 清空单元格 (${selected.row + 1}, ${getColumnName(selected.col)})`);
                    e.preventDefault();
                    break;
                case 'Backspace':
                    data.setCellValue(selected.row, selected.col, '');
                    renderer.render();
                    editor.startEdit(selected.row, selected.col);
                    e.preventDefault();
                    break;
                default:
                    // 直接输入字符替换内容
                    if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
                        editor.startEdit(selected.row, selected.col, e.key);
                        e.preventDefault();
                    }
                    break;
            }
            
            if (newRow !== selected.row || newCol !== selected.col) {
                renderer.setSelectedCell(newRow, newCol);
                const cellValue = data.getCellValue(newRow, newCol);
                updateStatus(`🎯 选中单元格 (${newRow + 1}, ${getColumnName(newCol)}): "${cellValue}"`);
            }
        });
        
        function getColumnName(col) {
            let name = '';
            while (col >= 0) {
                name = String.fromCharCode(65 + (col % 26)) + name;
                col = Math.floor(col / 26) - 1;
            }
            return name;
        }
        
        // 初始渲染
        renderer.render();
        updateStatus('✅ Excel风格编辑器已准备就绪！尝试不同的操作方式');
        
        // 调试对象
        window.excelTest = { data, renderer, editor };
    </script>
</body>
</html>