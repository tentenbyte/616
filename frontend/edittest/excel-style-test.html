<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Excelé£æ ¼ç¼–è¾‘æµ‹è¯•</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .instructions {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .instructions h3 {
            margin-top: 0;
            color: #1976d2;
        }
        .instructions ul {
            margin-bottom: 0;
        }
        .instructions li {
            margin-bottom: 5px;
        }
        canvas { 
            border: 2px solid #ddd; 
            display: block; 
            margin: 20px 0;
            border-radius: 4px;
        }
        .status {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š Excelé£æ ¼ç¼–è¾‘æµ‹è¯•</h1>
        
        <div class="instructions">
            <h3>ğŸ¯ Excelé£æ ¼æ“ä½œè¯´æ˜</h3>
            <ul>
                <li><strong>å•å‡»</strong> - é€‰ä¸­å•å…ƒæ ¼ï¼ˆæ˜¾ç¤ºè“è‰²è¾¹æ¡†ï¼‰</li>
                <li><strong>åŒå‡»</strong> - è¿›å…¥ç¼–è¾‘æ¨¡å¼</li>
                <li><strong>F2</strong> - è¿›å…¥ç¼–è¾‘æ¨¡å¼</li>
                <li><strong>ç›´æ¥è¾“å…¥å­—æ¯/æ•°å­—</strong> - æ›¿æ¢å•å…ƒæ ¼å†…å®¹å¹¶è¿›å…¥ç¼–è¾‘æ¨¡å¼</li>
                <li><strong>Enter</strong> - ä¿å­˜ç¼–è¾‘å¹¶ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œ</li>
                <li><strong>Tab</strong> - ä¿å­˜ç¼–è¾‘å¹¶ç§»åŠ¨åˆ°å³ä¾§å•å…ƒæ ¼</li>
                <li><strong>Shift+Tab</strong> - ä¿å­˜ç¼–è¾‘å¹¶ç§»åŠ¨åˆ°å·¦ä¾§å•å…ƒæ ¼</li>
                <li><strong>Escape</strong> - å–æ¶ˆç¼–è¾‘</li>
                <li><strong>Delete</strong> - æ¸…ç©ºå•å…ƒæ ¼å†…å®¹</li>
                <li><strong>Backspace</strong> - æ¸…ç©ºå•å…ƒæ ¼å¹¶è¿›å…¥ç¼–è¾‘æ¨¡å¼</li>
                <li><strong>æ–¹å‘é”®</strong> - ç§»åŠ¨é€‰æ‹©</li>
            </ul>
        </div>
        
        <canvas id="excelCanvas" width="600" height="300"></canvas>
        
        <div id="status" class="status">
            ç­‰å¾…æ“ä½œ...
        </div>
    </div>

    <!-- åŠ è½½æ‰€æœ‰æ¨¡å— -->
    <script src="../dataStructures.js"></script>
    <script src="../canvasRenderer.js"></script>
    <script src="../cellEditor.js"></script>
    
    <script>
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // åˆ›å»ºæµ‹è¯•æ•°æ®
        const data = new TableDataStructures(6, 4);
        
        // åŠ è½½ç¤ºä¾‹æ•°æ®
        const testData = [
            ['å§“å', 'å¹´é¾„', 'åŸå¸‚', 'èŒä¸š'],
            ['å¼ ä¸‰', '25', 'åŒ—äº¬', 'å·¥ç¨‹å¸ˆ'],
            ['æå››', '30', 'ä¸Šæµ·', 'è®¾è®¡å¸ˆ'],
            ['ç‹äº”', '28', 'å¹¿å·', 'äº§å“ç»ç†'],
            ['èµµå…­', '35', 'æ·±åœ³', 'æ¶æ„å¸ˆ']
        ];
        
        // ä¸´æ—¶ç§»é™¤ç¼–è¾‘é™åˆ¶
        const originalSetCell = data.setCellValue;
        data.setCellValue = function(row, col, value) {
            const stringIndex = this.addString(value);
            const cellIndex = col * this.rows + row;
            this.cellDataView[cellIndex] = stringIndex;
        };
        
        // åŠ è½½æ•°æ®
        for (let row = 0; row < testData.length; row++) {
            for (let col = 0; col < testData[row].length; col++) {
                data.setCellValue(row, col, testData[row][col]);
            }
        }
        
        data.currentRowCount = testData.length;
        data.setCellValue = originalSetCell; // æ¢å¤ï¼ˆä½†ä»ç„¶æ˜¯æ³¨é‡ŠçŠ¶æ€ï¼‰
        
        // åˆ›å»ºæ¸²æŸ“å™¨å’Œç¼–è¾‘å™¨
        const canvas = document.getElementById('excelCanvas');
        const renderer = new CanvasTableRenderer(canvas, data);
        const editor = new CellEditor(canvas.parentElement, renderer, data);
        
        // è®¾ç½®å›è°ƒ
        editor.onEditStart = (row, col, value) => {
            updateStatus(`âœï¸ å¼€å§‹ç¼–è¾‘å•å…ƒæ ¼ (${row + 1}, ${getColumnName(col)}): "${value}"`);
        };
        
        editor.onEditComplete = (row, col, newValue) => {
            updateStatus(`âœ… ç¼–è¾‘å®Œæˆ (${row + 1}, ${getColumnName(col)}): "${newValue}"`);
            renderer.render();
        };
        
        editor.onEditCancel = (row, col) => {
            updateStatus(`âŒ å–æ¶ˆç¼–è¾‘ (${row + 1}, ${getColumnName(col)})`);
        };
        
        editor.onCellMove = (row, col) => {
            const cellValue = data.getCellValue(row, col);
            updateStatus(`ğŸ“ ç§»åŠ¨åˆ°å•å…ƒæ ¼ (${row + 1}, ${getColumnName(col)}): "${cellValue}"`);
        };
        
        // å•å‡»é€‰æ‹©
        renderer.onCellSelected = (row, col) => {
            const cellValue = data.getCellValue(row, col);
            updateStatus(`ğŸ¯ é€‰ä¸­å•å…ƒæ ¼ (${row + 1}, ${getColumnName(col)}): "${cellValue}"`);
        };
        
        // åŒå‡»ç¼–è¾‘
        canvas.addEventListener('dblclick', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const cell = renderer.getCellFromPosition(x, y);
            
            if (cell.row >= 0 && cell.col >= 0) {
                editor.startEdit(cell.row, cell.col);
            }
        });
        
        // é”®ç›˜äº‹ä»¶å¤„ç†ï¼ˆç®€åŒ–ç‰ˆï¼‰
        document.addEventListener('keydown', (e) => {
            if (editor.isEditing) return;
            
            const selected = renderer.getSelectedCell();
            if (selected.row < 0 || selected.col < 0) return;
            
            let newRow = selected.row;
            let newCol = selected.col;
            
            switch (e.key) {
                case 'ArrowUp':
                    newRow = Math.max(0, selected.row - 1);
                    e.preventDefault();
                    break;
                case 'ArrowDown':
                    newRow = Math.min(data.currentRowCount - 1, selected.row + 1);
                    e.preventDefault();
                    break;
                case 'ArrowLeft':
                    newCol = Math.max(0, selected.col - 1);
                    e.preventDefault();
                    break;
                case 'ArrowRight':
                    newCol = Math.min(data.cols - 1, selected.col + 1);
                    e.preventDefault();
                    break;
                case 'Enter':
                case 'F2':
                    editor.startEdit(selected.row, selected.col);
                    e.preventDefault();
                    break;
                case 'Tab':
                    e.preventDefault();
                    if (e.shiftKey) {
                        newCol = Math.max(0, selected.col - 1);
                    } else {
                        newCol = Math.min(data.cols - 1, selected.col + 1);
                    }
                    break;
                case 'Delete':
                    data.setCellValue(selected.row, selected.col, '');
                    renderer.render();
                    updateStatus(`ğŸ—‘ï¸ æ¸…ç©ºå•å…ƒæ ¼ (${selected.row + 1}, ${getColumnName(selected.col)})`);
                    e.preventDefault();
                    break;
                case 'Backspace':
                    data.setCellValue(selected.row, selected.col, '');
                    renderer.render();
                    editor.startEdit(selected.row, selected.col);
                    e.preventDefault();
                    break;
                default:
                    // ç›´æ¥è¾“å…¥å­—ç¬¦æ›¿æ¢å†…å®¹
                    if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
                        editor.startEdit(selected.row, selected.col, e.key);
                        e.preventDefault();
                    }
                    break;
            }
            
            if (newRow !== selected.row || newCol !== selected.col) {
                renderer.setSelectedCell(newRow, newCol);
                const cellValue = data.getCellValue(newRow, newCol);
                updateStatus(`ğŸ¯ é€‰ä¸­å•å…ƒæ ¼ (${newRow + 1}, ${getColumnName(newCol)}): "${cellValue}"`);
            }
        });
        
        function getColumnName(col) {
            let name = '';
            while (col >= 0) {
                name = String.fromCharCode(65 + (col % 26)) + name;
                col = Math.floor(col / 26) - 1;
            }
            return name;
        }
        
        // åˆå§‹æ¸²æŸ“
        renderer.render();
        updateStatus('âœ… Excelé£æ ¼ç¼–è¾‘å™¨å·²å‡†å¤‡å°±ç»ªï¼å°è¯•ä¸åŒçš„æ“ä½œæ–¹å¼');
        
        // è°ƒè¯•å¯¹è±¡
        window.excelTest = { data, renderer, editor };
    </script>
</body>
</html>