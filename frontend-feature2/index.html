<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ—å¼è¡¨æ ¼ç¼–è¾‘å™¨</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- åŸºç¡€ä¾èµ– -->
    <script src="src/utils/helpers.js"></script>
    <script src="src/core/eventManager.js"></script>
    <script src="src/core/config.js"></script>
    
    <!-- åˆ—å¼æ•°æ®åº“ -->
    <script src="src/storage/IndexedDBManager.js"></script>
    <script src="src/storage/SimpleColumnarDB.js"></script>
    
    <!-- UIæ§ä»¶ -->
    <script src="src/widgets/NumberPad.js"></script>
    <script src="src/widgets/Calendar.js"></script>
    <script src="src/widgets/StringSelector.js"></script>
    <script src="src/widgets/EditWidget.js"></script>
    <script src="src/widgets/TableWidget.js"></script>
    
    <!-- ç­›é€‰æ¨¡å— -->
    <script src="src/modules/FilterManager.js"></script>
    <script src="src/modules/TableFilter.js"></script>
    <script src="src/widgets/FilterPanel.js"></script>
    
    <!-- æ ¸å¿ƒæ¨¡å— -->
    <script src="src/modules/renderer.js"></script>
    <script src="src/modules/SimpleTableCore.js"></script>
    
</head>
<body>
    <!-- è¡¨æ ¼å®¹å™¨ -->
    <div class="table-container" id="table-container">
        <canvas id="tableCanvas" tabindex="0"></canvas>
    </div>

    <!-- åº•éƒ¨çŠ¶æ€æ  -->
    <div class="footer">
        <div class="status">
            <span id="status-text">æ­£åœ¨åŠ è½½...</span>
        </div>
        <div class="info">
            <span id="info-text">åˆ—å¼å†…å­˜æ•°æ®åº“ + Canvasæ¸²æŸ“ + IndexedDBæŒä¹…åŒ– - ğŸ’¡æ“ä½œæç¤º: åˆ—å¤´å·¦ä¾§1/4æ’åºï¼Œå³ä¾§1/4ç­›é€‰</span>
        </div>
    </div>

    <!-- åº”ç”¨å¯åŠ¨è„šæœ¬ -->
    <script>
        (function() {
            'use strict';
            
            var app = { tableCore: null };
            window.app = app;
            
            var statusText = document.getElementById('status-text');
            var infoText = document.getElementById('info-text');
            
            // æ›´æ–°çŠ¶æ€ä¿¡æ¯
            function updateStatus(message, type) {
                if (statusText) {
                    statusText.textContent = message;
                    statusText.style.color = type === 'error' ? '#e74c3c' : 
                                           type === 'success' ? '#27ae60' : 'white';
                }
            }
            
            function updateInfo(message) {
                if (infoText) {
                    infoText.textContent = message;
                }
            }
            
            // åˆå§‹åŒ–Canvas
            function initializeCanvas() {
                var canvas = document.getElementById('tableCanvas');
                var container = document.getElementById('table-container');
                
                if (!canvas || !container) {
                    throw new Error('æ‰¾ä¸åˆ°Canvasæˆ–å®¹å™¨å…ƒç´ ');
                }
                
                var rect = container.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                canvas.style.width = rect.width + 'px';
                canvas.style.height = rect.height + 'px';
                
                return canvas;
            }
            
            // å¯åŠ¨åº”ç”¨
            function startApp() {
                try {
                    updateStatus('æ­£åœ¨æ£€æŸ¥æ¨¡å—...');
                    
                    // æ£€æŸ¥å¿…éœ€æ¨¡å—
                    if (!window.Config) throw new Error('Configæ¨¡å—æœªåŠ è½½');
                    if (!window.SimpleTableCore) throw new Error('SimpleTableCoreæ¨¡å—æœªåŠ è½½');
                    if (!window.SimpleColumnarDB) throw new Error('SimpleColumnarDBæ¨¡å—æœªåŠ è½½');
                    
                    updateStatus('æ­£åœ¨åˆå§‹åŒ–Canvas...');
                    var canvas = initializeCanvas();
                    
                    updateStatus('æ­£åœ¨åˆ›å»ºé…ç½®...');
                    var config = new window.Config();
                    
                    updateStatus('æ­£åœ¨åˆ›å»ºè¡¨æ ¼æ ¸å¿ƒ...');
                    app.tableCore = new window.SimpleTableCore(canvas, config);
                    
                    updateStatus('æ­£åœ¨åˆå§‹åŒ–æŒä¹…åŒ–ç³»ç»Ÿ...');
                    
                    // é¦–å…ˆåˆå§‹åŒ–æŒä¹…åŒ–ç³»ç»Ÿ
                    app.tableCore.db.initializePersistence()
                        .then(function(loadResult) {
                            updateStatus('æ­£åœ¨åˆå§‹åŒ–åº”ç”¨...');
                            
                            return app.tableCore.initialize().then(function() {
                                updateStatus('åº”ç”¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                                
                                // å¦‚æœæ²¡æœ‰åŠ è½½åˆ°æ•°æ®ï¼Œæ·»åŠ ç¤ºä¾‹æ•°æ®
                                if (!loadResult.loaded) {
                                    console.log('ğŸ“ æœªæ‰¾åˆ°æŒä¹…åŒ–æ•°æ®ï¼ŒåŠ è½½ç¤ºä¾‹æ•°æ®...');
                                    setTimeout(function() {
                                        addSampleDataIfNeeded();
                                        
                                        // æ ‡è®°å…ƒæ•°æ®ä¸ºè„æ•°æ®å¹¶ä¿å­˜
                                        app.tableCore.db.markMetadataDirty();
                                        app.tableCore.db.saveIncrementally().then(function() {
                                            console.log('âœ… ç¤ºä¾‹æ•°æ®å·²ä¿å­˜åˆ°IndexedDB');
                                        });
                                    }, 500);
                                } else {
                                    console.log('âœ… æˆåŠŸä»IndexedDBæ¢å¤æ•°æ®:', loadResult);
                                    // ç¡®ä¿UIçŠ¶æ€åŒæ­¥
                                    app.tableCore.db.currentRows = loadResult.totalRows;
                                    
                                    // ğŸ” è°ƒè¯•ï¼šéªŒè¯æ•°æ®æ˜¯å¦çœŸæ­£åŠ è½½
                                    console.log('ğŸ” éªŒè¯åŠ è½½çš„æ•°æ®:');
                                    for (var checkRow = 0; checkRow < Math.min(3, loadResult.totalRows); checkRow++) {
                                        for (var checkCol = 0; checkCol < Math.min(3, 8); checkCol++) {
                                            var value = app.tableCore.getCellValue(checkRow, checkCol);
                                            console.log('  [' + checkRow + ',' + checkCol + '] = "' + value + '"');
                                        }
                                    }
                                }
                                
                                updateStatus('åº”ç”¨å°±ç»ªï¼ŒåŒå‡»å•å…ƒæ ¼å¼€å§‹ç¼–è¾‘ - æ•°æ®å·²æŒä¹…åŒ–', 'success');
                                showStats();
                                enableAutoSave();
                            });
                        })
                        .catch(function(error) {
                            console.error('æŒä¹…åŒ–ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                            updateStatus('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                            
                            // å°è¯•æ— æŒä¹…åŒ–æ¨¡å¼å¯åŠ¨
                            updateStatus('å°è¯•æ— æŒä¹…åŒ–æ¨¡å¼å¯åŠ¨...', 'error');
                            app.tableCore.initialize()
                                .then(function() {
                                    updateStatus('åº”ç”¨ä»¥æ— æŒä¹…åŒ–æ¨¡å¼å¯åŠ¨', 'error');
                                    setTimeout(addSampleDataIfNeeded, 500);
                                })
                                .catch(function(fallbackError) {
                                    updateStatus('åº”ç”¨å¯åŠ¨å®Œå…¨å¤±è´¥: ' + fallbackError.message, 'error');
                                });
                        });
                        
                } catch (error) {
                    console.error('å¯åŠ¨å¤±è´¥:', error);
                    updateStatus('å¯åŠ¨å¤±è´¥: ' + error.message, 'error');
                }
            }
            
            // æ·»åŠ ç¤ºä¾‹æ•°æ®ï¼ˆä»…å½“æ•°æ®åº“ä¸ºç©ºæ—¶ï¼‰
            function addSampleDataIfNeeded() {
                if (!app.tableCore) {
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬ä»IndexedDBåŠ è½½çš„ï¼‰
                if (app.tableCore.db.totalRows > 0 || app.tableCore.db.currentRows > 0) {
                    console.log('â„¹ï¸ å·²æœ‰æ•°æ®ï¼Œè·³è¿‡ç¤ºä¾‹æ•°æ®åŠ è½½');
                    return;
                }
                
                try {
                    console.log('ğŸ“ æ•°æ®åº“ä¸ºç©ºï¼Œå¼€å§‹æ·»åŠ ç¤ºä¾‹æ•°æ®...');
                    
                    var sampleData = [
                        ['å¼ ä¸‰', '28', 'åŒ—äº¬', 'å·¥ç¨‹å¸ˆ', '15000', '123.45', '2024-01-15', 'åŒ—äº¬'],
                        ['æå››', '32', 'ä¸Šæµ·', 'è®¾è®¡å¸ˆ', '12000', '999.99', '2024-02-20', 'æ­å·'],
                        ['ç‹äº”', '25', 'å¹¿å·', 'äº§å“ç»ç†', '18000', '678.90', '2024-03-10', 'æ·±åœ³'],
                        ['èµµå…­', '29', 'æ·±åœ³', 'å‰ç«¯å¼€å‘', '16000', '456.78', '2024-04-15', 'å¹¿å·'],
                        ['å­™ä¸ƒ', '35', 'æ­å·', 'åç«¯å¼€å‘', '20000', '1234.56', '2024-05-22', 'æ­å·'],
                        ['å‘¨å…«', '27', 'å—äº¬', 'è¿ç»´å·¥ç¨‹å¸ˆ', '14000', '789.01', '2024-06-08', 'å—äº¬'],
                        ['å´ä¹', '31', 'æˆéƒ½', 'æ•°æ®åˆ†æå¸ˆ', '17000', '567.89', '2024-07-12', 'æˆéƒ½'],
                        ['éƒ‘å', '26', 'æ­¦æ±‰', 'UIè®¾è®¡å¸ˆ', '13000', '345.67', '2024-08-18', 'æ­¦æ±‰'],
                        ['å†¯åä¸€', '33', 'è¥¿å®‰', 'é¡¹ç›®ç»ç†', '22000', '2345.67', '2024-09-25', 'è¥¿å®‰'],
                        ['é™ˆåäºŒ', '24', 'é‡åº†', 'æµ‹è¯•å·¥ç¨‹å¸ˆ', '11000', '234.56', '2024-10-30', 'é‡åº†'],
                        ['è¤šåä¸‰', '30', 'å¤©æ´¥', 'æ¶æ„å¸ˆ', '28000', '3456.78', '2024-11-05', 'å¤©æ´¥'],
                        ['å«åå››', '28', 'é’å²›', 'ç®—æ³•å·¥ç¨‹å¸ˆ', '25000', '2567.89', '2024-12-12', 'é’å²›'],
                        ['è’‹åäº”', '32', 'å¤§è¿', 'æŠ€æœ¯æ€»ç›‘', '35000', '4567.89', '2025-01-08', 'å¤§è¿'],
                        ['æ²ˆåå…­', '26', 'å¦é—¨', 'ç§»åŠ¨å¼€å‘', '19000', '1345.67', '2025-02-14', 'å¦é—¨'],
                        ['éŸ©åä¸ƒ', '29', 'åˆè‚¥', 'å…¨æ ˆå¼€å‘', '21000', '1789.01', '2025-03-20', 'åˆè‚¥'],
                        ['æ¨åå…«', '34', 'é•¿æ²™', 'å®‰å…¨å·¥ç¨‹å¸ˆ', '23000', '1987.65', '2025-04-25', 'é•¿æ²™'],
                        ['æœ±åä¹', '27', 'éƒ‘å·', 'è¿è¥ä¸“å‘˜', '12000', '456.78', '2025-05-30', 'éƒ‘å·'],
                        ['ç§¦äºŒå', '31', 'çŸ³å®¶åº„', 'äººäº‹ç»ç†', '18000', '987.65', '2025-06-15', 'çŸ³å®¶åº„'],
                        ['å°¤äºŒä¸€', '25', 'å¤ªåŸ', 'å¸‚åœºä¸“å‘˜', '10000', '234.56', '2025-07-20', 'å¤ªåŸ'],
                        ['è®¸äºŒäºŒ', '36', 'ç¦å·', 'è´¢åŠ¡ç»ç†', '26000', '3210.98', '2025-08-28', 'ç¦å·']
                    ];
                    
                    // æ‰¹é‡æ·»åŠ æ•°æ®
                    console.log('ğŸ“ å¼€å§‹æ·»åŠ ç¤ºä¾‹æ•°æ®...');
                    for (var row = 0; row < sampleData.length; row++) {
                        for (var col = 0; col < sampleData[row].length; col++) {
                            try {
                                app.tableCore.setCellValue(row, col, sampleData[row][col]);
                                if (row === 0) { // åªè®°å½•ç¬¬ä¸€è¡Œï¼Œé¿å…å¤ªå¤šæ—¥å¿—
                                    console.log('âœ… æˆåŠŸè®¾ç½®[' + row + ',' + col + ']:', sampleData[row][col]);
                                }
                            } catch (error) {
                                console.error('âŒ è®¾ç½®å•å…ƒæ ¼[' + row + ',' + col + ']å¤±è´¥:', error);
                                console.error('   æ•°æ®:', sampleData[row][col]);
                                throw error; // é‡æ–°æŠ›å‡ºé”™è¯¯ä»¥ä¾¿ä¸Šå±‚å¤„ç†
                            }
                        }
                    }
                    console.log('âœ… ç¤ºä¾‹æ•°æ®æ·»åŠ å®Œæˆ');
                    
                    // ğŸ”§ æ›´æ–°æ•°æ®åº“çŠ¶æ€
                    if (app.tableCore && app.tableCore.db) {
                        app.tableCore.db.totalRows = 20;     // å­˜å‚¨å±‚æ€»è¡Œæ•°
                        app.tableCore.db.currentRows = 20;   // å‘åå…¼å®¹
                        app.tableCore.db.visibleRows = 20;   // è§†å›¾å±‚å¯è§è¡Œæ•°
                        app.tableCore.state.isDirty = true;
                        
                        // æ ‡è®°æ‰€æœ‰åˆ—ä¸ºè„æ•°æ®ä»¥ä¾¿ä¿å­˜
                        for (var col = 0; col < 8; col++) {
                            app.tableCore.db.markColumnDirty(col);
                        }
                        app.tableCore.db.markMetadataDirty();
                        
                        // ğŸ”§ å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿displayIndiceså­˜åœ¨å¹¶æ­£ç¡®åˆå§‹åŒ–
                        if (app.tableCore.db.displayIndices) {
                            for (var i = 0; i < 20; i++) {
                                app.tableCore.db.displayIndices[i] = i;
                            }
                            console.log('âœ… displayIndiceså·²åˆå§‹åŒ–:', Array.from(app.tableCore.db.displayIndices.slice(0, 5)));
                        } else {
                            console.error('âŒ displayIndicesæœªå®šä¹‰ï¼');
                        }
                    } else {
                        console.error('âŒ app.tableCoreæˆ–dbæœªå®šä¹‰ï¼');
                    }
                    
                    app.tableCore.render();
                    showStats();
                    
                    updateStatus('å·²åŠ è½½20è¡Œç¤ºä¾‹æ•°æ®', 'success');
                    
                } catch (error) {
                    console.error('åŠ è½½ç¤ºä¾‹æ•°æ®å¤±è´¥:', error);
                    updateStatus('åŠ è½½ç¤ºä¾‹æ•°æ®å¤±è´¥: ' + error.message, 'error');
                }
            }
            
            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            function showStats() {
                if (app.tableCore && app.tableCore.db) {
                    try {
                        var currentRows = app.tableCore.db.currentRows || 0;
                        var maxRows = app.tableCore.db.maxRows || 100;
                        var maxCols = app.tableCore.db.maxCols || 26;
                        updateInfo('åˆ—å¼å­˜å‚¨: ' + currentRows + '/' + maxRows + 'è¡Œ ' + maxCols + 'åˆ—');
                    } catch (error) {
                        updateInfo('åˆ—å¼å†…å­˜æ•°æ®åº“ + Canvasæ¸²æŸ“');
                    }
                }
            }
            
            // ğŸ—ºï¸ é‡æ–°ç¼–ç æ‰€æœ‰æ—¥æœŸæ•°æ®
            function reEncodeAllDates() {
                if (!app.tableCore) return;
                
                try {
                    console.log('ğŸ—ºï¸ å¼€å§‹é‡æ–°ç¼–ç æ‰€æœ‰æ—¥æœŸæ•°æ®...');
                    
                    // éµå¾ªåŸå§‹æ•°æ®çš„æ—¥æœŸæ ¼å¼
                    var dateData = [
                        '2024-01-15', '2024-02-20', '2024-03-10', '2024-04-15', '2024-05-22',
                        '2024-06-08', '2024-07-12', '2024-08-18', '2024-09-25', '2024-10-30',
                        '2024-11-05', '2024-12-12', '2025-01-08', '2025-02-14', '2025-03-20',
                        '2025-04-25', '2025-05-30', '2025-06-15', '2025-07-20', '2025-08-28'
                    ];
                    
                    // é‡æ–°è®¾ç½®Gåˆ—ï¼ˆç¬¬6åˆ—ï¼‰çš„æ‰€æœ‰æ—¥æœŸ
                    for (var row = 0; row < dateData.length && row < 20; row++) {
                        console.log('ğŸ“Œ é‡æ–°è®¾ç½®ç¬¬' + row + 'è¡Œçš„æ—¥æœŸ:', dateData[row]);
                        app.tableCore.setCellValue(row, 6, dateData[row]); // Gåˆ—æ˜¯ç¬¬6åˆ—
                    }
                    
                    console.log('âœ… æ—¥æœŸé‡æ–°ç¼–ç å®Œæˆï¼');
                    app.tableCore.render();
                    
                } catch (error) {
                    console.error('é‡æ–°ç¼–ç æ—¥æœŸå¤±è´¥:', error);
                }
            }
            
            // ğŸ”§ éªŒè¯æ•°æ®å®Œæ•´æ€§å’Œæ˜¾ç¤ºé—®é¢˜
            function validateDataIntegrity() {
                if (!app.tableCore) return;
                
                try {
                    console.log('ğŸ” éªŒè¯æ•°æ®å®Œæ•´æ€§...');
                    var db = app.tableCore.db;
                    
                    // æ£€æŸ¥å­˜å‚¨å±‚æ•°æ®
                    console.log('ğŸ“Š å­˜å‚¨å±‚çŠ¶æ€:');
                    console.log('   totalRows:', db.totalRows);
                    console.log('   visibleRows:', db.visibleRows);
                    console.log('   displayIndiceså‰5é¡¹:', Array.from(db.displayIndices.slice(0, 5)));
                    
                    // æ£€æŸ¥æ¯åˆ—çš„æ•°æ®
                    for (var col = 0; col < 8; col++) {
                        console.log('ğŸ” åˆ—' + col + 'æ•°æ®æ£€æŸ¥:');
                        
                        // å­˜å‚¨å±‚åŸå§‹æ•°æ®ï¼ˆå‰3è¡Œï¼‰
                        var storageData = [];
                        for (var row = 0; row < 3 && row < db.totalRows; row++) {
                            var encoded = db.columns[col][row];
                            var decoded = db.decode(encoded, col);
                            storageData.push({ row: row, encoded: encoded, decoded: decoded });
                        }
                        console.log('   å­˜å‚¨å±‚æ•°æ®:', storageData);
                        
                        // è§†å›¾å±‚æ˜¾ç¤ºæ•°æ®ï¼ˆå‰3è¡Œï¼‰
                        var viewData = [];
                        for (var viewRow = 0; viewRow < 3 && viewRow < db.visibleRows; viewRow++) {
                            var actualRow = db.displayIndices[viewRow];
                            var value = db.getDisplayValue(viewRow, col);
                            viewData.push({ viewRow: viewRow, actualRow: actualRow, value: value });
                        }
                        console.log('   è§†å›¾å±‚æ•°æ®:', viewData);
                        console.log('');
                    }
                    
                } catch (error) {
                    console.error('æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥:', error);
                }
            }
            
            // ğŸ”§ éªŒè¯æ—¥æœŸç¼–ç ä¿®å¤
            function validateDateEncodingFix() {
                if (!app.tableCore) return;
                
                try {
                    console.log('ğŸ”§ éªŒè¯æ—¥æœŸç¼–ç ä¿®å¤...');
                    
                    // è·å–Gåˆ—çš„ç¼–ç å€¼å¹¶æ˜¾ç¤ºæ’åºç»“æœ
                    var db = app.tableCore.db;
                    var encodedValues = [];
                    
                    // æ”¶é›†æ‰€æœ‰ç¼–ç å€¼å’ŒåŸå§‹æ—¥æœŸ
                    for (var row = 0; row < 20; row++) {
                        var encodedValue = db.columns[6][row]; // Gåˆ—ç¼–ç å€¼
                        var decodedValue = db.decode(encodedValue, 6); // è§£ç å›æ—¥æœŸ
                        encodedValues.push({
                            row: row,
                            encoded: encodedValue,
                            decoded: decodedValue,
                            hex: '0x' + encodedValue.toString(16)
                        });
                    }
                    
                    // æŒ‰ç¼–ç å€¼æ’åº
                    encodedValues.sort(function(a, b) { return a.encoded - b.encoded; });
                    
                    console.log('ğŸ“Š ä¿®å¤åçš„æ—¥æœŸç¼–ç æ’åºç»“æœ:');
                    console.log('   ç¼–ç å€¼ä»å°åˆ°å¤§çš„æ—¥æœŸé¡ºåº:');
                    for (var i = 0; i < encodedValues.length; i++) {
                        var item = encodedValues[i];
                        console.log('     ç¬¬' + item.row + 'è¡Œ: ' + item.decoded + ' â†’ ç¼–ç å€¼: ' + item.hex + ' (' + item.encoded + ')');
                    }
                    
                    // æ£€æŸ¥2024å¹´å’Œ2025å¹´çš„æ’åºæ˜¯å¦æ­£ç¡®
                    var dates2024 = encodedValues.filter(function(item) { return item.decoded.startsWith('2024'); });
                    var dates2025 = encodedValues.filter(function(item) { return item.decoded.startsWith('2025'); });
                    
                    if (dates2024.length > 0 && dates2025.length > 0) {
                        var max2024 = Math.max.apply(null, dates2024.map(function(item) { return item.encoded; }));
                        var min2025 = Math.min.apply(null, dates2025.map(function(item) { return item.encoded; }));
                        
                        console.log('ğŸ¯ å¹´ä»½æ’åºéªŒè¯:');
                        console.log('   2024å¹´æœ€å¤§ç¼–ç å€¼: ' + max2024 + ' (0x' + max2024.toString(16) + ')');
                        console.log('   2025å¹´æœ€å°ç¼–ç å€¼: ' + min2025 + ' (0x' + min2025.toString(16) + ')');
                        console.log('   æ’åºæ˜¯å¦æ­£ç¡®: ' + (max2024 < min2025 ? 'âœ… æ˜¯' : 'âŒ å¦'));
                    }
                    
                } catch (error) {
                    console.error('éªŒè¯æ—¥æœŸç¼–ç å¤±è´¥:', error);
                }
            }
            
            // å¯ç”¨è‡ªåŠ¨ä¿å­˜
            function enableAutoSave() {
                if (!app.tableCore) return;
                
                try {
                    if (app.tableCore.eventManager && window.EVENTS) {
                        app.tableCore.eventManager.on(window.EVENTS.TABLE_DATA_CHANGED, function() {
                            setTimeout(showStats, 100);
                        });
                    }
                } catch (error) {
                    console.error('å¯ç”¨è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
                }
            }
            
            // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°åˆå§‹åŒ–Canvas
            window.addEventListener('resize', function() {
                if (app.tableCore) {
                    setTimeout(function() {
                        try {
                            initializeCanvas();
                            app.tableCore.render();
                        } catch (error) {
                            console.error('é‡æ–°æ¸²æŸ“å¤±è´¥:', error);
                        }
                    }, 100);
                }
            });
            
            // å¯åŠ¨åº”ç”¨
            function init() {
                setTimeout(startApp, 100);
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
            
            
        })();
    </script>
</body>
</html>